{% extends "layouts/base.html" %} {% block title %}Dashboard - Personal
Tracker{% endblock %} {% block content %}
<!-- ChartJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="space-y-8 pb-4 h-full flex flex-col">
  <!-- 1. KPI CARDS (Fixed Top) -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 shrink-0">
    <!-- Pending Tasks -->
    <div
      class="bg-bgPrimary p-5 rounded-xl border border-borderColor shadow-sm flex items-center gap-4"
    >
      <div
        class="p-3 bg-blue-100 text-blue-600 rounded-lg dark:bg-blue-900/30 dark:text-blue-300"
      >
        <i class="ph-fill ph-check-square text-2xl"></i>
      </div>
      <div>
        <p class="text-sm text-txtSecondary font-medium">Pending Tasks</p>
        <h2 class="text-2xl font-bold text-txtPrimary">
          {{ stats.tasks_pending }}
        </h2>
      </div>
    </div>

    <!-- Open Bugs -->
    <div
      class="bg-bgPrimary p-5 rounded-xl border border-borderColor shadow-sm flex items-center gap-4"
    >
      <div
        class="p-3 bg-purple-100 text-purple-600 rounded-lg dark:bg-purple-900/30 dark:text-purple-300"
      >
        <i class="ph-fill ph-bug text-2xl"></i>
      </div>
      <div>
        <p class="text-sm text-txtSecondary font-medium">Open Bugs</p>
        <h2 class="text-2xl font-bold text-txtPrimary">
          {{ stats.bugs_open }}
        </h2>
      </div>
    </div>

    <!-- Due Today -->
    <div
      class="bg-bgPrimary p-5 rounded-xl border border-borderColor shadow-sm flex items-center gap-4"
    >
      <div
        class="p-3 bg-orange-100 text-orange-600 rounded-lg dark:bg-orange-900/30 dark:text-orange-300"
      >
        <i class="ph-fill ph-clock text-2xl"></i>
      </div>
      <div>
        <p class="text-sm text-txtSecondary font-medium">Due Today</p>
        <h2 class="text-2xl font-bold text-txtPrimary">
          {{ stats.due_today }}
        </h2>
      </div>
    </div>

    <!-- Overdue -->
    <div
      class="bg-bgPrimary p-5 rounded-xl border border-borderColor shadow-sm flex items-center gap-4"
    >
      <div
        class="p-3 bg-red-100 text-red-600 rounded-lg dark:bg-red-900/30 dark:text-red-300"
      >
        <i class="ph-fill ph-warning text-2xl"></i>
      </div>
      <div>
        <p class="text-sm text-txtSecondary font-medium">Critical / Overdue</p>
        <h2 class="text-2xl font-bold text-txtPrimary">{{ stats.overdue }}</h2>
      </div>
    </div>
  </div>

  <!-- MAIN SECTION -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 flex-1 min-h-0">
    <!-- LEFT: Focus Zone & Charts -->
    <div class="lg:col-span-2 flex flex-col gap-6 h-full overflow-hidden">
      <!-- Header -->
      <div class="flex justify-between items-center shrink-0">
        <h3 class="text-lg font-bold flex items-center gap-2">
          <i class="ph-fill ph-target text-accent"></i> Focus Zone
        </h3>
        <div class="flex gap-2">
          <a
            href="/tasks/new"
            class="text-xs bg-bgSecondary hover:bg-accent hover:text-white px-3 py-1.5 rounded-lg transition font-medium border border-borderColor"
          >
            + Task
          </a>
          <a
            href="/bugs/new"
            class="text-xs bg-bgSecondary hover:bg-accent hover:text-white px-3 py-1.5 rounded-lg transition font-medium border border-borderColor"
          >
            + Bug
          </a>
        </div>
      </div>

      <!-- SCROLLABLE CONTAINER FOR FOCUS ZONE -->
      <div
        class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-3 min-h-[300px]"
      >
        {% if urgent_items %} {% for item in urgent_items %}
        <a
          href="{{ item.link }}"
          class="block bg-bgPrimary p-4 rounded-xl border border-borderColor hover:shadow-md transition group border-l-4 {% if item.label_color == 'red' %} border-l-red-500 {% elif item.label_color == 'orange' %} border-l-orange-500 {% else %} border-l-blue-500 {% endif %}"
        >
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span
                  class="text-[10px] font-bold uppercase tracking-wide px-1.5 py-0.5 rounded bg-bgSecondary text-txtSecondary border border-borderColor"
                >
                  {{ item.type }}
                </span>
                <h4
                  class="font-bold text-txtPrimary group-hover:text-accent transition line-clamp-1"
                >
                  {{ item.title }}
                </h4>
              </div>
              <div class="flex items-center gap-3 text-xs text-txtSecondary">
                <span
                  class="flex items-center gap-1 font-bold {% if item.label_color == 'red' %} text-red-500 {% elif item.label_color == 'orange' %} text-orange-500 {% else %} text-blue-500 {% endif %}"
                >
                  <i class="ph-fill ph-calendar-blank"></i> {{ item.label }}: {{
                  item.date.strftime('%d %b') }}
                </span>
                <span class="flex items-center gap-1">
                  <span
                    class="w-1.5 h-1.5 rounded-full bg-{{ item.status_color }}-500"
                  ></span>
                  {{ item.status }}
                </span>
              </div>
            </div>
            <i
              class="ph-bold ph-caret-right text-txtSecondary group-hover:translate-x-1 transition"
            ></i>
          </div>
        </a>
        {% endfor %} {% else %}
        <div
          class="bg-bgPrimary p-8 rounded-xl border border-dashed border-borderColor text-center"
        >
          <div
            class="inline-flex p-4 rounded-full bg-green-50 text-green-600 mb-3 dark:bg-green-900/20"
          >
            <i class="ph-fill ph-coffee text-3xl"></i>
          </div>
          <h4 class="text-lg font-bold text-txtPrimary">All Caught Up!</h4>
          <p class="text-sm text-txtSecondary">
            No urgent tasks or overdue items.
          </p>
        </div>
        {% endif %}

        <!-- Charts placed below the list -->
        <div class="pt-6">
          <h3
            class="text-lg font-bold mb-4 flex items-center gap-2 sticky top-0 bg-bgSecondary/50 backdrop-blur-sm py-2 z-10"
          >
            <i class="ph-fill ph-chart-pie-slice text-accent"></i> Status
            Overview
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div
              class="bg-bgPrimary p-4 rounded-xl border border-borderColor shadow-sm"
            >
              <h5 class="text-sm font-bold text-txtSecondary mb-4 text-center">
                Task Distribution
              </h5>
              <div class="h-48 flex justify-center">
                <canvas id="taskChart"></canvas>
              </div>
            </div>
            <div
              class="bg-bgPrimary p-4 rounded-xl border border-borderColor shadow-sm"
            >
              <h5 class="text-sm font-bold text-txtSecondary mb-4 text-center">
                Bug Distribution
              </h5>
              <div class="h-48 flex justify-center">
                <canvas id="bugChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Pulse Activity Stream -->
    <div class="flex flex-col h-full overflow-hidden">
      <h3 class="text-lg font-bold mb-6 flex items-center gap-2 shrink-0">
        <i class="ph-fill ph-pulse text-accent"></i> Activity Pulse
      </h3>

      <!-- SCROLLABLE CONTAINER -->
      <div class="flex-1 overflow-y-auto custom-scrollbar px-2">
        <div class="relative pl-4 border-l-2 border-borderColor space-y-8">
          {% for act in activities %}
          <div class="relative">
            <!-- Dot -->
            <div
              class="absolute -left-[21px] top-1.5 w-3 h-3 rounded-full border-2 border-bgPrimary {% if act.type == 'Task' %} bg-blue-500 {% else %} bg-purple-500 {% endif %}"
            ></div>

            <div class="flex justify-between items-baseline mb-1">
              <span
                class="text-[10px] font-bold uppercase tracking-wider text-txtSecondary"
                >{{ act.type }}</span
              >
              <span class="text-[10px] text-txtSecondary"
                >{{ act.time | local }}</span
              >
            </div>

            <a href="{{ act.link }}" class="block group">
              <p
                class="text-xs font-bold text-txtPrimary group-hover:text-accent transition line-clamp-1"
              >
                {{ act.parent_title }}
              </p>
              <!-- REVERTED: Removed whitespace-pre-wrap, restored line-clamp-2 -->
              <p
                class="text-xs text-txtSecondary mt-1 bg-bgPrimary p-2 rounded border border-borderColor shadow-sm line-clamp-2 group-hover:border-accent/30 transition"
              >
                {{ act.content }}
              </p>
            </a>
          </div>
          {% endfor %} {% if not activities %}
          <p class="text-sm text-txtSecondary italic pl-2">
            No recent activity.
          </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Script -->
<script>
  // Expanded Color Mapper (Supports all standard Tailwind colors)
  const colors = {
      'slate': '#64748b', 'gray': '#6b7280', 'zinc': '#71717a',
      'neutral': '#737373', 'stone': '#78716c', 'red': '#ef4444',
      'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
      'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981',
      'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9',
      'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6',
      'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
      'rose': '#f43f5e'
  };

  function renderChart(id, data) {
      const ctx = document.getElementById(id);
      if(!ctx) return;

      // Map DB color names to Hex, default to gray if missing
      const bgColors = data.colors.map(c => colors[c] || colors['gray']);

      new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: data.labels,
              datasets: [{
                  data: data.counts,
                  backgroundColor: bgColors,
                  borderWidth: 0,
                  hoverOffset: 4
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom',
                      labels: {
                          usePointStyle: true,
                          font: { size: 10 },
                          color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                      }
                  }
              }
          }
      });
  }

  const taskData = {{ chart_data.tasks | tojson }};
  const bugData = {{ chart_data.bugs | tojson }};

  document.addEventListener('DOMContentLoaded', () => {
      renderChart('taskChart', taskData);
      renderChart('bugChart', bugData);
  });
</script>
{% endblock %}
